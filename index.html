<!DOCTYPE html><html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ระบบห้องสมุดโรงเรียน — ยืม คืน QR</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    :root{ --lib-green:#10b981; --lib-blue:#3b82f6; --lib-purple:#8b5cf6; }
    .grad{ background: linear-gradient(135deg,var(--lib-green),var(--lib-blue),var(--lib-purple)); }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">
  <header class="grad text-white p-5 shadow">
    <div class="max-w-6xl mx-auto flex items-center gap-4">
      <h1 class="text-2xl font-extrabold">ระบบห้องสมุดโรงเรียน</h1>
      <div class="ml-auto text-sm opacity-90">เวอร์ชัน: QR + JSONP (กล้องหน้า/หลัง สลับได้)</div>
    </div>
  </header>  <main class="max-w-6xl mx-auto p-6 space-y-6">
    <nav class="bg-white rounded-2xl shadow p-3 flex gap-2 flex-wrap">
      <button data-tab="loan" class="tab-btn px-4 py-2 rounded-xl bg-emerald-100 text-emerald-900 font-semibold">ยืม-คืน</button>
      <button data-tab="add" class="tab-btn px-4 py-2 rounded-xl hover:bg-blue-100">เพิ่มหนังสือ</button>
      <button data-tab="gate" class="tab-btn px-4 py-2 rounded-xl hover:bg-violet-100">เข้า-ออก</button>
      <button data-tab="assistant" class="tab-btn px-4 py-2 rounded-xl hover:bg-emerald-100">ผู้ช่วย</button>
      <button data-tab="stats" class="tab-btn ml-auto px-4 py-2 rounded-xl bg-slate-100">สถิติ</button>
    </nav><!-- LOAN PANEL -->
<section id="loan" class="tab-panel bg-white rounded-2xl shadow p-6 space-y-4">
  <div class="md:flex md:items-start md:gap-6">
    <div class="md:w-1/2 space-y-3">
      <h2 class="text-xl font-bold text-emerald-700">ยืม-คืน (สแกน QR หรือกรอกรหัส)</h2>
      <p class="text-sm text-slate-600">แนะนำให้ใช้กล้องหลังเป็นค่าเริ่มต้น — หากต้องการเปลี่ยนให้กด สลับกล้อง</p>

      <div class="p-3 rounded-xl border bg-slate-50">
        <div id="qr-region" class="w-full aspect-video rounded-lg overflow-hidden bg-black flex items-center justify-center"></div>
        <div class="mt-3 flex gap-2">
          <button id="btnStartQR" class="px-3 py-2 rounded-xl bg-emerald-600 text-white">เปิดกล้อง</button>
          <button id="btnSwitchCamera" class="px-3 py-2 rounded-xl bg-purple-600 text-white">สลับกล้อง</button>
          <button id="btnStopQR" class="px-3 py-2 rounded-xl bg-red-500 text-white">ปิดกล้อง</button>
        </div>
        <div id="cameraList" class="mt-2 text-xs text-slate-500"></div>
      </div>

      <div class="p-3 rounded-xl border bg-white">
        <label class="block text-sm font-medium mb-2">กรอกรหัสหนังสือ (ถ้าไม่สแกน)</label>
        <div class="flex gap-2">
          <input id="manualBookCode" type="text" placeholder="เช่น BK-000123" class="flex-1 px-3 py-2 rounded-xl border" />
          <button id="btnSearchBook" class="px-4 py-2 rounded-xl bg-blue-600 text-white">ค้นหา</button>
        </div>
        <p class="mt-2 text-xs text-slate-500">ระบบจะดึงข้อมูลจากชีต “รายชื่อหนังสือ” มาเติมอัตโนมัติ</p>
      </div>

      <div class="text-xs text-slate-500">หมายเหตุ: ต้องให้สิทธิ์กล้องกับเบราว์เซอร์ของคุณ (HTTPS จำเป็นสำหรับมือถือบางรุ่น)</div>
    </div>

    <div class="md:w-1/2">
      <form id="loanForm" class="space-y-3 bg-white p-4 rounded-xl border">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="text-sm">เลขประจำตัวนักเรียน</label>
            <input name="studentId" required pattern="[0-9]{4}" maxlength="4" placeholder="0001" class="w-full px-3 py-2 rounded-xl border" />
          </div>
          <div>
            <label class="text-sm">ชื่อนักเรียน</label>
            <input name="studentName" required placeholder="ชื่อ-สกุล" class="w-full px-3 py-2 rounded-xl border" />
          </div>
        </div>

        <div>
          <label class="text-sm">ชื่อหนังสือ</label>
          <input id="title" name="title" required class="w-full px-3 py-2 rounded-xl border" />
        </div>

        <div class="grid md:grid-cols-2 gap-3">
          <div>
            <label class="text-sm">ผู้แต่ง</label>
            <input id="author" name="author" required class="w-full px-3 py-2 rounded-xl border" />
          </div>
          <div>
            <label class="text-sm">หมวดหมู่ดิวอี้</label>
            <select id="deweyLoan" name="dewey" required class="w-full px-3 py-2 rounded-xl border"></select>
          </div>
        </div>

        <div class="grid md:grid-cols-3 gap-3">
          <div>
            <label class="text-sm">สำนักพิมพ์</label>
            <input id="publisher" name="publisher" required class="w-full px-3 py-2 rounded-xl border" />
          </div>
          <div>
            <label class="text-sm">ปีที่พิมพ์</label>
            <input id="year" name="year" inputmode="numeric" pattern="[0-9]{4}" class="w-full px-3 py-2 rounded-xl border" />
          </div>
          <div>
            <label class="text-sm">รหัสหนังสือ</label>
            <input id="bookCodeLoan" name="bookCode" required class="w-full px-3 py-2 rounded-xl border" />
          </div>
        </div>

        <div>
          <label class="text-sm">ประเภท</label>
          <select name="type" class="w-full px-3 py-2 rounded-xl border">
            <option value="ยืม">ยืม</option>
            <option value="คืน">คืน</option>
          </select>
        </div>

        <div class="flex gap-2">
          <button type="submit" class="px-4 py-2 rounded-xl bg-emerald-600 text-white font-semibold">บันทึก</button>
          <button type="reset" class="px-4 py-2 rounded-xl bg-slate-200">ล้าง</button>
        </div>
      </form>
    </div>
  </div>
</section>

<!-- ADD BOOK -->
<section id="add" class="tab-panel hidden bg-white rounded-2xl shadow p-6">
  <h2 class="text-xl font-bold text-blue-700">เพิ่มหนังสือ</h2>
  <form id="addForm" class="mt-4 grid md:grid-cols-2 gap-4">
    <div class="space-y-3">
      <label class="text-sm">ชื่อหนังสือ</label>
      <input name="title" required class="w-full px-3 py-2 rounded-xl border" />
      <label class="text-sm">ผู้แต่ง</label>
      <input name="author" required class="w-full px-3 py-2 rounded-xl border" />
      <label class="text-sm">หมวดหมู่ดิวอี้</label>
      <select id="deweyAdd" name="dewey" class="w-full px-3 py-2 rounded-xl border"></select>
    </div>
    <div class="space-y-3">
      <label class="text-sm">สำนักพิมพ์</label>
      <input name="publisher" class="w-full px-3 py-2 rounded-xl border" />
      <label class="text-sm">ปีที่พิมพ์</label>
      <input name="year" pattern="[0-9]{4}" class="w-full px-3 py-2 rounded-xl border" />
      <label class="text-sm">รหัสหนังสือ (จะใช้กับ QR)</label>
      <input name="bookCode" required class="w-full px-3 py-2 rounded-xl border" />
      <div class="flex gap-2 mt-2">
        <button class="px-4 py-2 rounded-xl bg-blue-600 text-white" type="submit">บันทึกหนังสือ</button>
        <button type="reset" class="px-4 py-2 rounded-xl bg-slate-200">ล้าง</button>
      </div>
    </div>
  </form>
</section>

<!-- GATE -->
<section id="gate" class="tab-panel hidden bg-white rounded-2xl shadow p-6">
  <h2 class="text-xl font-bold text-violet-700">บันทึกเข้า-ออกห้องสมุด</h2>
  <form id="gateForm" class="mt-4 grid md:grid-cols-2 gap-4">
    <div>
      <label class="text-sm">เลขประจำตัวนักเรียน</label>
      <input name="studentId" required pattern="[0-9]{4}" class="w-full px-3 py-2 rounded-xl border" />
    </div>
    <div>
      <label class="text-sm">ชื่อนักเรียน</label>
      <input name="studentName" required class="w-full px-3 py-2 rounded-xl border" />
    </div>
    <div>
      <label class="text-sm">ประเภท</label>
      <select name="type" class="w-full px-3 py-2 rounded-xl border">
        <option value="เข้า">เข้า</option>
        <option value="ออก">ออก</option>
      </select>
    </div>
    <div class="flex items-end">
      <button type="submit" class="px-4 py-2 rounded-xl bg-violet-600 text-white">บันทึก</button>
    </div>
  </form>
</section>

<!-- ASSISTANT -->
<section id="assistant" class="tab-panel hidden bg-white rounded-2xl shadow p-6">
  <h2 class="text-xl font-bold text-emerald-700">ผู้ช่วยบรรณารักษ์</h2>
  <form id="assistantForm" class="mt-4 space-y-3">
    <div class="grid md:grid-cols-2 gap-3">
      <input name="studentId" required pattern="[0-9]{4}" placeholder="เลขประจำตัว" class="px-3 py-2 rounded-xl border" />
      <input name="studentName" required placeholder="ชื่อนักเรียน" class="px-3 py-2 rounded-xl border" />
    </div>
    <div>
      <label class="text-sm">งานที่ทำ</label>
      <div class="grid sm:grid-cols-2 gap-2 mt-2">
        <label class="flex items-center gap-2"><input type="checkbox" name="tasks" value="กวาดพื้น"> กวาดพื้น</label>
        <label class="flex items-center gap-2"><input type="checkbox" name="tasks" value="ถูพื้น"> ถูพื้น</label>
        <label class="flex items-center gap-2"><input type="checkbox" name="tasks" value="จัดเก็บหนังสือ"> จัดเก็บหนังสือ</label>
        <label class="flex items-center gap-2"><input type="checkbox" name="tasks" value="เช็ดโต๊ะ"> เช็ดโต๊ะ</label>
        <label class="flex items-center gap-2"><input type="checkbox" name="tasks" value="บริการการยืม-คืน"> บริการการยืม-คืน</label>
        <label class="flex items-center gap-2"><input type="checkbox" name="tasks" value="เช็ดชั้นหนังสือ"> เช็ดชั้นหนังสือ</label>
      </div>
    </div>
    <div>
      <button type="submit" class="px-4 py-2 rounded-xl bg-emerald-600 text-white">บันทึกงานผู้ช่วย</button>
    </div>
  </form>
</section>

<!-- STATS -->
<section id="stats" class="tab-panel hidden bg-white rounded-2xl shadow p-6">
  <h2 class="text-xl font-bold">สถิติ</h2>
  <div class="grid md:grid-cols-3 gap-4 mt-4">
    <div class="p-4 rounded-xl bg-emerald-50 border"><div class="text-sm">จำนวนการยืม</div><div id="statBorrow" class="text-2xl font-bold">-</div></div>
    <div class="p-4 rounded-xl bg-blue-50 border"><div class="text-sm">จำนวนการคืน</div><div id="statReturn" class="text-2xl font-bold">-</div></div>
    <div class="p-4 rounded-xl bg-violet-50 border"><div class="text-sm">รายการล่าสุด</div><div id="statRecent" class="text-sm">-</div></div>
  </div>
  <div class="mt-4"><button id="btnRefreshStats" class="px-4 py-2 rounded-xl bg-slate-800 text-white">รีเฟรช</button></div>
</section>

  </main>  <footer class="max-w-6xl mx-auto p-4 text-center text-xs text-slate-500">เชื่อมต่อ Google Apps Script ด้วย JSONP — ใช้ได้กับ Android/iOS (ต้องเป็น HTTPS)</footer><script>
// ================== CONFIG ==================
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyxF13nNkv7pFU2iyYEWtZQpPU8DZvVKOgfZ6Hgw4QEVfDZ0zqRjyyb9gbjQjzGp3BA_A/exec';
const SHEET_BORROW = 'ยืม-คืน';
const SHEET_BOOKS  = 'รายชื่อหนังสือ';
const SHEET_GATE   = 'เข้า-ออก';
const SHEET_ASSIST = 'ผู้ช่วย';

const DEWEY = [
  ['000','คอมพิวเตอร์ ความรู้ทั่วไป'],['100','ปรัชญา จิตวิทยา'],['200','ศาสนา'],['300','สังคมศาสตร์'],['400','ภาษา'],['500','วิทยาศาสตร์'],['600','เทคโนโลยี'],['700','ศิลปะ กีฬา'],['800','วรรณคดี'],['900','ประวัติศาสตร์ ภูมิศาสตร์']
];
function fillDewey(select){
  select.innerHTML = '<option value="">— เลือกหมวดหมู่ดิวอี้ —</option>' + DEWEY.map(d=>`<option value="${d[0]} ${d[1]}">${d[0]} — ${d[1]}</option>`).join('');
}
fillDewey(document.getElementById('deweyLoan'));
fillDewey(document.getElementById('deweyAdd'));

// TAB HANDLER
const tabBtns = document.querySelectorAll('.tab-btn');
const panels = document.querySelectorAll('.tab-panel');
function showTab(id){ panels.forEach(p=>p.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); }
tabBtns.forEach(b=>b.addEventListener('click', ()=> showTab(b.dataset.tab)));
showTab('loan');

// JSONP helper
function jsonp(params){
  return new Promise((resolve,reject)=>{
    const cbName = 'cb_' + Math.random().toString(36).slice(2);
    window[cbName] = (data)=>{ resolve(data); cleanup(); };
    const query = new URLSearchParams({...params, callback: cbName}).toString();
    const s = document.createElement('script');
    s.src = `${SCRIPT_URL}?${query}`;
    s.onerror = ()=>{ reject(new Error('JSONP error')); cleanup(); };
    document.body.appendChild(s);
    function cleanup(){ delete window[cbName]; s.remove(); }
  });
}

function toastLoading(title='กำลังบันทึก...'){ Swal.fire({ title, didOpen: ()=> Swal.showLoading(), allowOutsideClick:false, showConfirmButton:false }); }
function toastSuccess(msg='สำเร็จ'){ Swal.fire({ icon:'success', title:msg, timer:1200, showConfirmButton:false }); }
function toastError(msg='ผิดพลาด'){ Swal.fire({ icon:'error', title:msg }); }

// ================== QR + CAMERA SWITCH ==================
let html5QrCode = null;
let cameras = [];
let currentCameraIndex = 0;

async function listCameras(){
  try{
    cameras = await Html5Qrcode.getCameras();
    const div = document.getElementById('cameraList');
    if(!cameras || cameras.length===0){ div.textContent = 'ไม่พบกล้อง'; return; }
    div.innerHTML = '<div class="text-sm">อุปกรณ์กล้อง:</div>' + cameras.map((c,i)=>`<div class="text-xs">${i+1}. ${c.label || c.id}</div>`).join('');
  }catch(e){ document.getElementById('cameraList').textContent = 'ไม่สามารถเข้าถึงกล้องได้'; }
}

async function startCameraByIndex(idx){
  try{
    if(html5QrCode){ await html5QrCode.stop(); html5QrCode.clear(); html5QrCode = null; }
    await listCameras();
    currentCameraIndex = idx || 0;
    const camera = cameras[currentCameraIndex];
    if(!camera) return toastError('ไม่พบกล้อง');
    html5QrCode = new Html5Qrcode('qr-region');
    await html5QrCode.start({ deviceId: { exact: camera.id } }, { fps:10, qrbox: 250 }, onScanSuccess, ()=>{});
    Swal.fire({ icon:'info', title:'เปิดกล้องแล้ว', timer:900, showConfirmButton:false });
  }catch(e){ toastError('เปิดกล้องไม่สำเร็จ: ' + (e.message||e)); }
}

async function stopCamera(){ if(html5QrCode){ await html5QrCode.stop(); html5QrCode.clear(); html5QrCode = null; Swal.fire({icon:'info',title:'ปิดกล้องแล้ว',timer:700,showConfirmButton:false}); } }

function switchCamera(){
  if(!cameras || cameras.length===0) return toastError('ไม่พบกล้องให้สลับ');
  currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
  startCameraByIndex(currentCameraIndex);
}

async function onScanSuccess(decodedText){
  // คาดว่า decodedText = รหัสหนังสือ
  document.getElementById('bookCodeLoan').value = decodedText.trim();
  // ดึงข้อมูลจากชีต
  try{
    const res = await jsonp({ action:'getBookByCode', sheet: SHEET_BOOKS, code: decodedText.trim() });
    if(res?.ok && res.book){ fillBookForm(res.book); toastSuccess('สแกนสำเร็จ'); }
    else { toastError(res?.message || 'ไม่พบหนังสือ'); }
  }catch(e){ toastError('ดึงข้อมูลไม่สำเร็จ'); }
}

function fillBookForm(book){
  document.getElementById('title').value = book.title || '';
  document.getElementById('author').value = book.author || '';
  const sel = document.getElementById('deweyLoan');
  if(book.dewey){
    let found = false;
    for(const opt of sel.options){ if(opt.value === book.dewey){ found = true; break; } }
    if(!found){ sel.insertAdjacentHTML('beforeend', `<option value="${book.dewey}" selected>${book.dewey}</option>`); }
    sel.value = book.dewey;
  }
  document.getElementById('publisher').value = book.publisher || '';
  document.getElementById('year').value = book.year || '';
  document.getElementById('bookCodeLoan').value = book.bookCode || '';
}

// BUTTONS
document.getElementById('btnStartQR').addEventListener('click', async ()=>{ await listCameras(); await startCameraByIndex(currentCameraIndex); });
document.getElementById('btnStopQR').addEventListener('click', stopCamera);
document.getElementById('btnSwitchCamera').addEventListener('click', switchCamera);

// Manual search by code
document.getElementById('btnSearchBook').addEventListener('click', async ()=>{
  const code = document.getElementById('manualBookCode').value.trim();
  if(!code) return toastError('กรุณากรอกรหัสหนังสือ');
  Swal.fire({ title:'กำลังค้นหา...', didOpen:()=>Swal.showLoading(), allowOutsideClick:false, showConfirmButton:false });
  try{
    const res = await jsonp({ action:'getBookByCode', sheet: SHEET_BOOKS, code });
    Swal.close();
    if(res?.ok && res.book){ fillBookForm(res.book); toastSuccess('ดึงข้อมูลหนังสือเรียบร้อย'); }
    else{ toastError(res?.message || 'ไม่พบข้อมูลหนังสือ'); }
  }catch(e){ Swal.close(); toastError('เชื่อมต่อผิดพลาด'); }
});

// ================== FORMS SUBMIT ==================
// ยืม-คืน
document.getElementById('loanForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const f = e.target;
  const payload = {
    action:'addBorrowReturn', sheet:SHEET_BORROW,
    studentId: f.studentId.value.trim(), studentName: f.studentName.value.trim(),
    title: f.title.value.trim(), author: f.author.value.trim(), dewey: f.dewey.value.trim(),
    publisher: f.publisher.value.trim(), year: f.year.value.trim(), bookCode: f.bookCode.value.trim(), type: f.type.value
  };
  toastLoading();
  try{ const res = await jsonp(payload); Swal.close(); if(res?.ok){ toastSuccess('บันทึกสำเร็จ'); f.reset(); } else toastError(res?.message||'บันทึกไม่สำเร็จ'); }
  catch(err){ Swal.close(); toastError('การเชื่อมต่อผิดพลาด'); }
});

// เพิ่มหนังสือ
document.getElementById('addForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const f = e.target;
  const payload = { action:'addBook', sheet:SHEET_BOOKS, title: f.title.value.trim(), author: f.author.value.trim(), dewey: f.dewey.value.trim(), publisher: f.publisher.value.trim(), year: f.year.value.trim(), bookCode: f.bookCode.value.trim() };
  toastLoading('กำลังบันทึกหนังสือ...');
  try{ const res = await jsonp(payload); Swal.close(); if(res?.ok){ toastSuccess('เพิ่มหนังสือสำเร็จ'); f.reset(); } else toastError(res?.message||'บันทึกไม่สำเร็จ'); }
  catch(err){ Swal.close(); toastError('การเชื่อมต่อผิดพลาด'); }
});

// เข้า-ออก
document.getElementById('gateForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const f = e.target;
  const payload = { action:'addGate', sheet:SHEET_GATE, studentId: f.studentId.value.trim(), studentName: f.studentName.value.trim(), type: f.type.value };
  toastLoading('กำลังบันทึกเข้า/ออก...');
  try{ const res = await jsonp(payload); Swal.close(); if(res?.ok){ toastSuccess('บันทึกสำเร็จ'); f.reset(); } else toastError(res?.message||'บันทึกไม่สำเร็จ'); }
  catch(err){ Swal.close(); toastError('การเชื่อมต่อผิดพลาด'); }
});

// ผู้ช่วย
document.getElementById('assistantForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const f = e.target; const tasks = [...f.querySelectorAll('input[name="tasks"]:checked')].map(i=>i.value);
  if(tasks.length===0) return toastError('กรุณาเลือกงานที่ทำ');
  const payload = { action:'addAssistant', sheet:SHEET_ASSIST, studentId: f.studentId.value.trim(), studentName: f.studentName.value.trim(), tasks: tasks.join(', ') };
  toastLoading('กำลังบันทึก...');
  try{ const res = await jsonp(payload); Swal.close(); if(res?.ok){ toastSuccess('บันทึกงานผู้ช่วยเรียบร้อย'); f.reset(); } else toastError(res?.message||'บันทึกไม่สำเร็จ'); }
  catch(err){ Swal.close(); toastError('การเชื่อมต่อผิดพลาด'); }
});

// สถิติ
async function refreshStats(){
  try{ const res = await jsonp({ action:'getStats', sheet: SHEET_BORROW }); if(res?.ok){ document.getElementById('statBorrow').textContent = res.borrow || 0; document.getElementById('statReturn').textContent = res.return || 0; document.getElementById('statRecent').innerHTML = (res.recent||[]).map(r=>`<div>• ${r}</div>`).join('') || '-'; } else toastError('ดึงสถิติไม่สำเร็จ'); }
  catch(e){ toastError('เชื่อมต่อสถิติผิดพลาด'); }
}
document.getElementById('btnRefreshStats').addEventListener('click', refreshStats);
refreshStats();

// โหลดกล้องล่วงหน้า
listCameras();
</script></body>
</html>

<!DOCTYPE html><html lang="th">
<head>
  <meta charset="UTF-8">
  <title>р╕лр╣Йр╕нр╕Зр╕кр╕бр╕╕р╕Фр╣Вр╕гр╕Зр╣Ар╕гр╕╡р╕вр╕Щ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="bg-gradient-to-r from-green-200 via-blue-200 to-purple-200 min-h-screen p-6">
  <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-xl p-6">
    <h1 class="text-3xl font-bold text-center text-purple-700 mb-6">ЁЯУЪ р╕гр╕░р╕Ър╕Ър╕лр╣Йр╕нр╕Зр╕кр╕бр╕╕р╕Фр╣Вр╕гр╕Зр╣Ар╕гр╕╡р╕вр╕Щ</h1><div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <button onclick="showSection('borrowReturn')" class="p-4 bg-green-500 text-white rounded-xl shadow hover:bg-green-600">р╕вр╕╖р╕б-р╕Др╕╖р╕Щ р╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н</button>
  <button onclick="showSection('addBook')" class="p-4 bg-blue-500 text-white rounded-xl shadow hover:bg-blue-600">р╣Ар╕Юр╕┤р╣Ир╕бр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н</button>
  <button onclick="showSection('entryExit')" class="p-4 bg-purple-500 text-white rounded-xl shadow hover:bg-purple-600">р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Ар╕Вр╣Йр╕▓-р╕нр╕нр╕Б р╕лр╣Йр╕нр╕Зр╕кр╕бр╕╕р╕Ф</button>
  <button onclick="showSection('assistant')" class="p-4 bg-pink-500 text-white rounded-xl shadow hover:bg-pink-600">р╕Ьр╕╣р╣Йр╕Кр╣Ир╕зр╕вр╕Ър╕гр╕гр╕Ур╕▓р╕гр╕▒р╕Бр╕йр╣М</button>
</div>

<!-- р╕вр╕╖р╕б-р╕Др╕╖р╕Щ р╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н -->
<div id="borrowReturn" class="hidden mt-6">
  <h2 class="text-2xl font-semibold text-green-700 mb-4">ЁЯУЦ р╕вр╕╖р╕б-р╕Др╕╖р╕Щ р╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н</h2>
  <div id="qr-reader" class="w-full h-64 border rounded-xl mb-4"></div>
  <button onclick="startScanner(selectedCamera)" class="px-4 py-2 bg-indigo-500 text-white rounded-xl">р╣Ар╕Ыр╕┤р╕Фр╕Бр╕ер╣Йр╕нр╕З</button>
  <button onclick="switchCamera()" class="px-4 py-2 bg-gray-500 text-white rounded-xl ml-2">р╕кр╕ер╕▒р╕Ър╕Бр╕ер╣Йр╕нр╕З</button>
  <form id="borrowReturnForm" class="mt-4 space-y-2">
    <input id="studentId" placeholder="р╣Ар╕ер╕Вр╕Ыр╕гр╕░р╕Ир╕│р╕Хр╕▒р╕зр╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ" class="w-full p-2 border rounded" required>
    <input id="studentName" placeholder="р╕Кр╕╖р╣Ир╕нр╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ" class="w-full p-2 border rounded" required>
    <input id="bookTitle" placeholder="р╕Кр╕╖р╣Ир╕нр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н" class="w-full p-2 border rounded" required>
    <input id="bookAuthor" placeholder="р╕Ьр╕╣р╣Йр╣Бр╕Хр╣Ир╕З" class="w-full p-2 border rounded" required>
    <select id="bookDewey" class="w-full p-2 border rounded">
      <option value="">р╣Ар╕ер╕╖р╕нр╕Бр╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕Фр╕┤р╕зр╕нр╕╡р╣Й</option>
      <option>000 тАУ р╣Ар╕Ър╣Зр╕Фр╣Ар╕Хр╕ер╣Зр╕Ф</option>
      <option>100 тАУ р╕Ыр╕гр╕▒р╕Кр╕Нр╕▓</option>
      <option>200 тАУ р╕ир╕▓р╕кр╕Щр╕▓</option>
      <option>300 тАУ р╕кр╕▒р╕Зр╕Др╕бр╕ир╕▓р╕кр╕Хр╕гр╣М</option>
      <option>400 тАУ р╕ар╕▓р╕йр╕▓</option>
      <option>500 тАУ р╕зр╕┤р╕Чр╕вр╕▓р╕ир╕▓р╕кр╕Хр╕гр╣М</option>
      <option>600 тАУ р╣Ар╕Чр╕Др╣Вр╕Щр╣Вр╕ер╕вр╕╡</option>
      <option>700 тАУ р╕ир╕┤р╕ер╕Ыр╕░р╣Бр╕ер╕░р╕Бр╕▓р╕гр╕Ър╕▒р╕Щр╣Ар╕Чр╕┤р╕З</option>
      <option>800 тАУ р╕зр╕гр╕гр╕Ур╕Др╕Фр╕╡</option>
      <option>900 тАУ р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕ир╕▓р╕кр╕Хр╕гр╣Мр╣Бр╕ер╕░р╕ар╕╣р╕бр╕┤р╕ир╕▓р╕кр╕Хр╕гр╣М</option>
    </select>
    <input id="bookPublisher" placeholder="р╕кр╕│р╕Щр╕▒р╕Бр╕Юр╕┤р╕бр╕Юр╣М" class="w-full p-2 border rounded">
    <input id="bookYear" placeholder="р╕Ыр╕╡р╕Чр╕╡р╣Ир╕Юр╕┤р╕бр╕Юр╣М" class="w-full p-2 border rounded">
    <input id="bookCode" placeholder="р╕гр╕лр╕▒р╕кр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н" class="w-full p-2 border rounded" required>
    <select id="transactionType" class="w-full p-2 border rounded" required>
      <option value="р╕вр╕╖р╕б">р╕вр╕╖р╕б</option>
      <option value="р╕Др╕╖р╕Щ">р╕Др╕╖р╕Щ</option>
    </select>
    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-xl">р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б</button>
  </form>
</div>

<!-- р╣Ар╕Юр╕┤р╣Ир╕бр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н -->
<div id="addBook" class="hidden mt-6">
  <h2 class="text-2xl font-semibold text-blue-700 mb-4">тЮХ р╣Ар╕Юр╕┤р╣Ир╕бр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н</h2>
  <form id="addBookForm" class="space-y-2">
    <input id="addTitle" placeholder="р╕Кр╕╖р╣Ир╕нр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н" class="w-full p-2 border rounded" required>
    <input id="addAuthor" placeholder="р╕Ьр╕╣р╣Йр╣Бр╕Хр╣Ир╕З" class="w-full p-2 border rounded" required>
    <select id="addDewey" class="w-full p-2 border rounded">
      <option value="">р╣Ар╕ер╕╖р╕нр╕Бр╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣Ир╕Фр╕┤р╕зр╕нр╕╡р╣Й</option>
      <option>000 тАУ р╣Ар╕Ър╣Зр╕Фр╣Ар╕Хр╕ер╣Зр╕Ф</option>
      <option>100 тАУ р╕Ыр╕гр╕▒р╕Кр╕Нр╕▓</option>
      <option>200 тАУ р╕ир╕▓р╕кр╕Щр╕▓</option>
      <option>300 тАУ р╕кр╕▒р╕Зр╕Др╕бр╕ир╕▓р╕кр╕Хр╕гр╣М</option>
      <option>400 тАУ р╕ар╕▓р╕йр╕▓</option>
      <option>500 тАУ р╕зр╕┤р╕Чр╕вр╕▓р╕ир╕▓р╕кр╕Хр╕гр╣М</option>
      <option>600 тАУ р╣Ар╕Чр╕Др╣Вр╕Щр╣Вр╕ер╕вр╕╡</option>
      <option>700 тАУ р╕ир╕┤р╕ер╕Ыр╕░р╣Бр╕ер╕░р╕Бр╕▓р╕гр╕Ър╕▒р╕Щр╣Ар╕Чр╕┤р╕З</option>
      <option>800 тАУ р╕зр╕гр╕гр╕Ур╕Др╕Фр╕╡</option>
      <option>900 тАУ р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕ир╕▓р╕кр╕Хр╕гр╣Мр╣Бр╕ер╕░р╕ар╕╣р╕бр╕┤р╕ир╕▓р╕кр╕Хр╕гр╣М</option>
    </select>
    <input id="addPublisher" placeholder="р╕кр╕│р╕Щр╕▒р╕Бр╕Юр╕┤р╕бр╕Юр╣М" class="w-full p-2 border rounded">
    <input id="addYear" placeholder="р╕Ыр╕╡р╕Чр╕╡р╣Ир╕Юр╕┤р╕бр╕Юр╣М" class="w-full p-2 border rounded">
    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-xl">р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б</button>
  </form>
</div>

<!-- р╣Ар╕Вр╣Йр╕▓-р╕нр╕нр╕Б р╕лр╣Йр╕нр╕Зр╕кр╕бр╕╕р╕Ф -->
<div id="entryExit" class="hidden mt-6">
  <h2 class="text-2xl font-semibold text-purple-700 mb-4">ЁЯЪк р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Ар╕Вр╣Йр╕▓-р╕нр╕нр╕Б р╕лр╣Йр╕нр╕Зр╕кр╕бр╕╕р╕Ф</h2>
  <form id="entryExitForm" class="space-y-2">
    <input id="entryStudentId" placeholder="р╣Ар╕ер╕Вр╕Ыр╕гр╕░р╕Ир╕│р╕Хр╕▒р╕зр╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ" class="w-full p-2 border rounded" required>
    <input id="entryStudentName" placeholder="р╕Кр╕╖р╣Ир╕нр╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ" class="w-full p-2 border rounded" required>
    <select id="entryType" class="w-full p-2 border rounded" required>
      <option value="р╣Ар╕Вр╣Йр╕▓">р╣Ар╕Вр╣Йр╕▓</option>
      <option value="р╕нр╕нр╕Б">р╕нр╕нр╕Б</option>
    </select>
    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-xl">р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б</button>
  </form>
</div>

<!-- р╕Ьр╕╣р╣Йр╕Кр╣Ир╕зр╕вр╕Ър╕гр╕гр╕Ур╕▓р╕гр╕▒р╕Бр╕йр╣М -->
<div id="assistant" class="hidden mt-6">
  <h2 class="text-2xl font-semibold text-pink-700 mb-4">ЁЯЩЛ р╕Ьр╕╣р╣Йр╕Кр╣Ир╕зр╕вр╕Ър╕гр╕гр╕Ур╕▓р╕гр╕▒р╕Бр╕йр╣М</h2>
  <form id="assistantForm" class="space-y-2">
    <input id="assistantName" placeholder="р╕Кр╕╖р╣Ир╕нр╕Ьр╕╣р╣Йр╕Кр╣Ир╕зр╕в" class="w-full p-2 border rounded" required>
    <select id="assistantTask" class="w-full p-2 border rounded" required>
      <option>р╕Бр╕зр╕▓р╕Фр╕Юр╕╖р╣Йр╕Щ</option>
      <option>р╕Цр╕╣р╕Юр╕╖р╣Йр╕Щ</option>
      <option>р╕Ир╕▒р╕Фр╣Ар╕Бр╣Зр╕Ър╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н</option>
      <option>р╣Ар╕Кр╣Зр╕Фр╣Вр╕Хр╣Кр╕░</option>
      <option>р╕Ър╕гр╕┤р╕Бр╕▓р╕гр╕Бр╕▓р╕гр╕вр╕╖р╕б-р╕Др╕╖р╕Щр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н</option>
      <option>р╣Ар╕Кр╣Зр╕Фр╕Кр╕▒р╣Йр╕Щр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н</option>
    </select>
    <button type="submit" class="px-4 py-2 bg-pink-600 text-white rounded-xl">р╕Ър╕▒р╕Щр╕Чр╕╢р╕Б</button>
  </form>
</div>

  </div>  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyxF13nNkv7pFU2iyYEWtZQpPU8DZvVKOgfZ6Hgw4QEVfDZ0zqRjyyb9gbjQjzGp3BA_A/exec";
    let html5QrCode;
    let cameras = [];
    let selectedCamera;
    let isScanning = false;

    function showSection(id) {
      document.querySelectorAll('#borrowReturn, #addBook, #entryExit, #assistant').forEach(el => el.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    function startScanner(cameraId) {
      if (html5QrCode) {
        html5QrCode.stop().catch(()=>{});
      }
      html5QrCode = new Html5QrCode("qr-reader");
      isScanning = false;
      html5QrCode.start(
        cameraId,
        { fps: 10, qrbox: { width: 300, height: 200 } },
        (decodedText) => {
          if (isScanning) return;
          isScanning = true;
          fetchBookByCode(decodedText);
          html5QrCode.stop().catch(()=>{});
        },
        (errorMessage) => {}
      );
    }

    function switchCamera() {
      Html5Qrcode.getCameras().then(devices => {
        if (devices.length > 1) {
          selectedCamera = (selectedCamera === devices[0].id) ? devices[1].id : devices[0].id;
          startScanner(selectedCamera);
        }
      });
    }

    function fetchBookByCode(code) {
      swal({ title: "р╕Бр╕│р╕ер╕▒р╕Зр╕Др╣Йр╕Щр╕лр╕▓...", buttons: false, closeOnClickOutside: false });
      const url = SCRIPT_URL + "?action=getBookByCode&code=" + encodeURIComponent(code) + "&callback=?";
      $.getJSON(url, (res) => {
        swal.close();
        if (res.ok && res.book) {
          $("#bookTitle").val(res.book.title);
          $("#bookAuthor").val(res.book.author);
          $("#bookDewey").val(res.book.dewey);
          $("#bookPublisher").val(res.book.publisher);
          $("#bookYear").val(res.book.year);
          $("#bookCode").val(res.book.bookCode);
          swal("р╕кр╕│р╣Ар╕гр╣Зр╕И", "р╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕нр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в", "success");
        } else {
          swal("р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕е", res.message || "р╕гр╕лр╕▒р╕кр╕Щр╕╡р╣Йр╣Др╕бр╣Ир╕бр╕╡р╣Гр╕Щр╕гр╕░р╕Ър╕Ъ", "error");
        }
        isScanning = false;
      });
    }

    // р╣Вр╕лр╕ер╕Фр╕Бр╕ер╣Йр╕нр╕З
    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        cameras = devices;
        selectedCamera = devices[0].id;
      }
    });

    // р╕Яр╕нр╕гр╣Мр╕б р╕вр╕╖р╕б-р╕Др╕╖р╕Щ
    $("#borrowReturnForm").submit(function(e){
      e.preventDefault();
      const data = {
        action: "borrowReturn",
        studentId: $("#studentId").val(),
        studentName: $("#studentName").val(),
        bookTitle: $("#bookTitle").val(),
        bookAuthor: $("#bookAuthor").val(),
        bookDewey: $("#bookDewey").val(),
        bookPublisher: $("#bookPublisher").val(),
        bookYear: $("#bookYear").val(),
        bookCode: $("#bookCode").val(),
        transactionType: $("#transactionType").val()
      };
      swal({ title:"р╕Бр╕│р╕ер╕▒р╕Зр╕Ър╕▒р╕Щр╕Чр╕╢р╕Б...", buttons: false });
      $.ajax({
        url: SCRIPT_URL,
        dataType: "jsonp",
        data: data,
        success: function(){ swal("р╕кр╕│р╣Ар╕гр╣Зр╕И","р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в","success"); }
      });
    });

    // р╕Яр╕нр╕гр╣Мр╕б р╣Ар╕Юр╕┤р╣Ир╕бр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕н
    $("#addBookForm").submit(function(e){
      e.preventDefault();
      const data = {
        action: "addBook",
        title: $("#addTitle").val(),
        author: $("#addAuthor").val(),
        dewey: $("#addDewey").val(),
        publisher: $("#addPublisher").val(),
        year: $("#addYear").val()
      };
      swal({ title:"р╕Бр╕│р╕ер╕▒р╕Зр╕Ър╕▒р╕Щр╕Чр╕╢р╕Б...", buttons: false });
      $.ajax({
        url: SCRIPT_URL,
        dataType: "jsonp",
        data: data,
        success: function(){ swal("р╕кр╕│р╣Ар╕гр╣Зр╕И","р╣Ар╕Юр╕┤р╣Ир╕бр╕лр╕Щр╕▒р╕Зр╕кр╕╖р╕нр╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в","success"); }
      });
    });

    // р╕Яр╕нр╕гр╣Мр╕б р╣Ар╕Вр╣Йр╕▓-р╕нр╕нр╕Б р╕лр╣Йр╕нр╕Зр╕кр╕бр╕╕р╕Ф
    $("#entryExitForm").submit(function(e){
      e.preventDefault();
      const data = {
        action: "entryExit",
        studentId: $("#entryStudentId").val(),
        studentName: $("#entryStudentName").val(),
        entryType: $("#entryType").val()
      };
      swal({ title:"р╕Бр╕│р╕ер╕▒р╕Зр╕Ър╕▒р╕Щр╕Чр╕╢р╕Б...", buttons: false });
      $.ajax({
        url: SCRIPT_URL,
        dataType: "jsonp",
        data: data,
        success: function(){ swal("р╕кр╕│р╣Ар╕гр╣Зр╕И","р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓-р╕нр╕нр╕Бр╣Бр╕ер╣Йр╕з","success"); }
      });
    });

    // р╕Яр╕нр╕гр╣Мр╕б р╕Ьр╕╣р╣Йр╕Кр╣Ир╕зр╕вр╕Ър╕гр╕гр╕Ур╕▓р╕гр╕▒р╕Бр╕йр╣М
    $("#assistantForm").submit(function(e){
      e.preventDefault();
      const data = {
        action: "assistant",
        name: $("#assistantName").val(),
        task: $("#assistantTask").val()
      };
      swal({ title:"р╕Бр╕│р╕ер╕▒р╕Зр╕Ър╕▒р╕Щр╕Чр╕╢р╕Б...", buttons: false });
      $.ajax({
        url: SCRIPT_URL,
        dataType: "jsonp",
        data: data,
        success: function(){ swal("р╕кр╕│р╣Ар╕гр╣Зр╕И","р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ьр╕╣р╣Йр╕Кр╣Ир╕зр╕вр╣Бр╕ер╣Йр╕з","success"); }
      });
    });
  </script></body>
</html>
